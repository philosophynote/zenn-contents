---
title: "Q.クローラー修正時にunicornの再起動が必要ない理由を答えよ"
emoji: "🤔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Rails","unicorn"]
published: false
---

## Answer

クローラーのコードとアプリケーションサーバーであるunicornが独立しているため

## 執筆動機

タイトルの疑問は昨年の秋頃から持ち始めたものの、
色々なことを言い訳にして特に調べずにいました。

しかしながら、時間が過ぎるにつれて自分がリリース時期を決定したり、
自力で保守運用をする必要が出てきたため、自分で調べることにしました。

## まずunicornとは何か？

WEBアプリケーション3段構成
WEBサーバー：リクエストを受け取り、WEBアプリケーションに処理を渡す
アプリケーションサーバー：WEBアプリケーションの処理を行う
DBサーバー：データの永続化を行う

## アプリケーションサーバーって何？

## 開発環境と本番環境の違い

WEBアプリケーションはローカルの開発環境では次のような構成になっています。

一方で本番環境では次のような構成になっています。

開発環境と異なり、本番環境では複数のリクエストが同時に来ることが想定されます。
このため、ブラウザのリクエストからのリクエストを受けるWEBサーバーを配置し、
WEBアプリケーションはそれらのWEBサーバーの裏で動作させます。

Rubyの場合、RackというWEBサーバー同士を接続させるインターフェースがあります。
前段にワーカープロセスを起動するUnicorn,Puma,PassengerなどのWEBサーバーを置いて、
その裏側をRackで接続し、パフォーマンスを上げる構成がよく取られます。

## unicorn使用時のRailsの挙動

1.プロセスの生成:
まず、Railsアプリケーションが起動する際には、アプリケーションサーバー（例: unicornやpuma）が新しいプロセスを生成します。このプロセスはオペレーティングシステムから独立したメモリ空間を持ちます。

2.初期化コードの実行:
プロセスが起動されると、Railsはその初期化コードを実行します。これにはconfig/application.rbやconfig/environments/*.rb、さらにinitializersディレクトリ内のファイルなど、様々な初期設定や設定コードが含まれます。

3.コードの読み込み:
この初期化の過程で、必要なライブラリやGem、アプリケーションのコード（モデル、コントローラ、ヘルパーなど）がメモリ上に読み込まれます。これにより、リクエストの処理中に毎回ディスクからコードを読み込む必要がなくなり、応答速度が向上します。

4.ワーカープロセス/スレッドの生成:
アプリケーションサーバーによっては、この時点で複数のワーカープロセスやスレッドを生成します。unicornの場合、ワーカープロセスが生成されます。pumaの場合は、スレッドとプロセスの両方を扱うことができます。この時点で前回起動時のRailsアプリケーションの状態（メモリ上のコードやデータ）はすべて破棄され、新しくロードされたコードや設定が有効になります。

- ワーカープロセス:
これは親プロセスからフォークされた子プロセスです。それぞれのプロセスは独立したメモリ空間を持ちますが、起動時に読み込まれたコードやライブラリは共有されます。

- スレッド:
スレッドは、同じプロセス内の複数の実行単位です。同じプロセス内のスレッドは、そのプロセスのメモリ空間を共有します。したがって、同一のコードやライブラリを使用します。

## プロセスとスレッドの違い

了解しました。以下はスレッドとプロセスの違いを表形式でまとめたものです。

| 項目               | スレッド                                 | プロセス                                 |
|-------------------|----------------------------------------|----------------------------------------|
| **定義**            | プロセス内の実行単位。                 | オペレーティングシステムの下で実行される独立したプログラムのインスタンス。 |
| **メモリとリソース** | 同じプロセス内のメモリ空間、コード、データを共有。独自のレジスタとスタックを持つ。 | 独自のメモリ空間、コード、データ、およびシステムリソースを持つ。 |
| **開始と終了**       | 高速。                                | 比較的遅い。                            |
| **通信**            | 共有メモリを使用し効率的。               | IPCを使用し、オーバーヘッドが伴う。          |
| **オーバーヘッド**    | コンテキストスイッチのオーバーヘッドが少ない。 | コンテキストスイッチのオーバーヘッドが多い。  |
| **障害の影響**       | 1つのスレッドの障害が他のスレッドに影響する可能性がある。 | 1つのプロセスの障害が他のプロセスに影響しない。 |
| **独立性**          | リソースの共有により調整や同期が必要。     | 独立して動作し、他のプロセスの動作に影響を与えることは少ない。 |

この表は、スレッドとプロセスの違いを一目で把握するのに役立ちます。

## クローラー動作時の挙動

1.cronの起動:

システムが起動すると、cronデーモン（daemon）も自動的に起動します。cronデーモンは、指定された時間にジョブを実行するためのバックグラウンドプロセスです。

2.スケジュールの確認:

cronは、特定の間隔でcrontabファイルの内容（具体的には/etc/crontabや/var/spool/cron/下のユーザー固有のcrontab）をチェックし、指定された時間にジョブを実行するためのスケジュールを決定します。

3.クローラースクリプトの起動:

ジョブの実行時刻が来ると、cronは新しい子プロセスをフォークし、そのプロセス内でクローラースクリプトを実行します。このとき、Rubyインタープリタ（例えば /usr/bin/rubyなど）が起動し、指定されたスクリプトファイル（この場合crawler_script.rb）を実行します。

4.Rubyの実行:

Rubyインタープリタは、スクリプト内のコードを上から順に解釈・実行していきます。このスクリプトの場合、ChromeDriverを使ってウェブページをクロールする処理が行われます。

5.終了:

スクリプトの全ての行が実行されると、Rubyプロセスは終了します。子プロセスも終了するため、このプロセスの占有していたメモリやその他のリソースはOSによって解放されます。

この手順では、マルチスレッドやマルチワーカーのような高度な並行処理の技術は使用されていません。シンプルな単一プロセス、シングルスレッドのRubyプログラムとして実行されます。

## 実演

## 補題：unicornとpumaの違い

Unicorn:pre-working型のアプリケーションサーバー。
マスタープロセスが複数のワーカープロセスを生成し、各リクエストをワーカープロセスに振り分けて処理を行います。

Puma:スレッドベースのアプリケーションサーバー。
マルチスレッドをサポートしているため、複数のリクエストを同時に処理することができます。
この疑問について回答するにはまずWEBアプリケーションが動作する環境について理解する必要があります。
