---
title: "WEBMOCKとVCRの使い方"
emoji: "📼"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Ruby","Rspec","vcr"]
published: false
---

## WEBMOCKとVCRの使い方

外部APIを呼び出す処理がある場合、
テストを実行する度に外部と通信するのは避けたいところです。
Rubyで開発する際にWebMockやVCRを使うことで、
テスト時に外部APIと通信せず、
事前に取得したレスポンスを再利用することができます。
本記事では、WebMockとVCRを説明し、実際にOpenAIにアクセスするRubyクラスのRSpecを作成する方法を紹介します。

## 「モック」と「スタブ」

内容に入る前に、まず「モック」と「スタブ」の違いについて説明します。

:::message
モック：テスト対象システムからその依存に向かって行われる外部に向かうコミュニケーション（出力）を模倣し、そして、検証するのに使われる。

スタブ：依存からテスト対象システムに向かって行われる内部に向かうコミュニケーション（入力）を模倣するのに使われる。
:::

## WebMock

Webmockは、RubyのテストフレームワークでHTTPリクエストをスタブ化(mock)するためのgemです。
外部のWebサービスに実際にリクエストを送る代わりに、レスポンスをスタブ化することで、
テストの安定性と速度を向上させることができます。

しかし、すべてのリクエストに対するレスポンスをコード内に記述する必要があります。

## VCR

VCRは、実際のHTTPリクエストを記録し、その結果をキャッシュするGemです。
後続のテストではキャッシュからレスポンスを読み込むので、実際にWebリクエストを発行する必要がありません。VCRを使えばリクエストとレスポンスを自動的に再現できます。。

OpenAIのAPIキーのような機密情報を含むリクエストをキャッシュする場合、VCRのconfigに設定を記載することで、
マスクしたい文字列にマスクをかけることができます。

ただし上手くマスクできない場合もあるので、次の記事を参考にしてください。

https://qiita.com/gotchane/items/c2c29c0063bd44246510

## コード例
